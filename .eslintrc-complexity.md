# Code Complexity & Refactoring Guidelines (SonarJS)

This project uses **SonarJS** for detecting code that needs refactoring.

## What is Cognitive Complexity?

**Cognitive Complexity** is a metric that measures how difficult code is to understand. Unlike Cyclomatic Complexity (which just counts branches), Cognitive Complexity considers:

1. **Nested control flow** - Each level of nesting adds to complexity
2. **Logical operators** - `&&` and `||` add complexity
3. **Recursion** - Recursive calls increase complexity
4. **Break in flow** - `break`, `continue`, early `return` statements

**Why it's better**: A flat function with 10 `if` statements has lower cognitive complexity than a deeply nested function with 5 `if` statements, because nesting is harder to understand.

## Complexity Thresholds

| Score | Priority | Action |
|-------|----------|--------|
| > 50 | ðŸ”´ CRITICAL | Refactor immediately - extremely hard to maintain |
| 30-50 | ðŸŸ  HIGH | Schedule refactoring soon - too complex |
| 20-30 | ðŸŸ¡ MEDIUM | Consider simplification - getting complex |
| 15-20 | ðŸŸ¢ LOW | Monitor - acceptable but watch for growth |
| â‰¤ 15 | âœ… GOOD | Maintainable |

## Commands

```bash
# Full lint report
npm run lint

# Only complexity issues
npm run lint:complexity

# Auto-fix what can be fixed
npm run lint:fix

# Strict mode (fails on warnings)
npm run lint:strict
```

## Top 3 Files Needing Refactoring

Based on current analysis:

1. **ðŸŸ  api/routers/utils/index.ts:733** - Cognitive: 42
2. **ðŸŸ  api/routers/playlists/index.ts:23** - Cognitive: 35
3. **ðŸŸ  api/routers/transcripts/index.ts:102** - Cognitive: 33

## Refactoring Strategies

### 1. Extract Methods
Break large functions into smaller, focused ones:

```typescript
// Before: Cognitive Complexity = 35
async function getPlaylistDetails(id) {
  // 200+ lines of: fetch, parse, validate, save, transform...
}

// After: Cognitive Complexity = 8
async function getPlaylistDetails(id) {
  const data = await fetchPlaylistData(id);
  const validated = validatePlaylistData(data);
  await savePlaylistToDatabase(validated);
  return transformPlaylistResponse(validated);
}
```

### 2. Early Returns (Guard Clauses)
Reduce nesting with early returns:

```typescript
// Before: High nesting = High cognitive complexity
function process(user) {
  if (user) {
    if (user.isActive) {
      if (user.hasPermission) {
        // do work
      }
    }
  }
}

// After: Flat structure = Low cognitive complexity
function process(user) {
  if (!user) return;
  if (!user.isActive) return;
  if (!user.hasPermission) return;
  // do work
}
```

### 3. Strategy Pattern
Replace complex conditionals:

```typescript
// Before: Many if/else = High complexity
function handle(type) {
  if (type === 'A') { /* 20 lines */ }
  else if (type === 'B') { /* 20 lines */ }
  else if (type === 'C') { /* 20 lines */ }
  // ... etc
}

// After: Strategy pattern = Low complexity
const handlers = {
  A: handleTypeA,
  B: handleTypeB,
  C: handleTypeC,
};

function handle(type) {
  return handlers[type]?.() ?? handleDefault();
}
```

### 4. Extract Nested Logic
Move nested code to separate functions:

```typescript
// Before: Deep nesting
for (const item of items) {
  if (item.type === 'video') {
    if (item.duration > 0) {
      if (!item.processed) {
        // complex logic here
      }
    }
  }
}

// After: Extracted function
for (const item of items) {
  if (shouldProcessVideo(item)) {
    processVideo(item);
  }
}
```

## SonarJS Rules Enabled

### Cognitive Complexity
- `sonarjs/cognitive-complexity` - Main complexity metric (max: 15)

### Code Smells
- `sonarjs/no-duplicate-string` - Detects repeated strings (threshold: 3)
- `sonarjs/no-identical-functions` - Finds duplicate functions
- `sonarjs/no-duplicated-branches` - if/else with identical code

### Code Quality
- `sonarjs/no-collection-size-mischeck` - Wrong array/collection size checks
- `sonarjs/no-identical-conditions` - Same condition in multiple places
- `sonarjs/no-inverted-boolean-check` - !(a == b) should be a != b
- `sonarjs/no-redundant-boolean` - x === true should be x
- `sonarjs/prefer-single-boolean-return` - Simplify boolean returns

## Benefits of Cognitive Complexity

âœ… **More accurate** than cyclomatic complexity
âœ… **Per-function measurement** - pinpoint exact problem areas
âœ… **Industry standard** - used by SonarQube
âœ… **Research-backed** - based on cognitive science studies
âœ… **Better refactoring targets** - identifies truly complex code

## References

- [SonarJS Rules Documentation](https://github.com/SonarSource/eslint-plugin-sonarjs)
- [Cognitive Complexity Whitepaper](https://www.sonarsource.com/docs/CognitiveComplexity.pdf)
