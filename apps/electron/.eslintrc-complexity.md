# Code Complexity & Refactoring Guidelines

This file documents the ESLint rules for detecting code that needs refactoring.

## Complexity Metrics Explained

### 1. **Cyclomatic Complexity** (`complexity`)
- **What**: Measures the number of independent paths through code
- **Threshold**: Max 15
- **Why it matters**: High complexity = harder to test, more bugs
- **How to fix**: Extract functions, use early returns, simplify conditionals

### 2. **Max Lines Per Function** (`max-lines-per-function`)
- **What**: Total lines in a single function
- **Threshold**: Max 100 lines
- **Why it matters**: Long functions are hard to understand and maintain
- **How to fix**: Break into smaller, focused functions with single responsibilities

### 3. **Max Lines Per File** (`max-lines`)
- **What**: Total lines in a file
- **Threshold**: Max 500 lines
- **Why it matters**: Large files are hard to navigate
- **How to fix**: Split into multiple files by domain/responsibility

### 4. **Max Nested Callbacks** (`max-nested-callbacks`)
- **What**: Depth of nested callback functions
- **Threshold**: Max 4 levels
- **Why it matters**: "Callback hell" is hard to read
- **How to fix**: Use async/await, extract functions, Promise chains

### 5. **Max Depth** (`max-depth`)
- **What**: Nesting depth of if/for/while blocks
- **Threshold**: Max 4 levels
- **Why it matters**: Deep nesting is hard to follow
- **How to fix**: Early returns, guard clauses, extract functions

### 6. **Max Parameters** (`max-params`)
- **What**: Number of function parameters
- **Threshold**: Max 5 parameters
- **Why it matters**: Many parameters = hard to use, easy to misorder
- **How to fix**: Use object parameters, split function, builder pattern

## Best Practices for Refactoring

### Priority 1: High Complexity Functions
Focus on functions with complexity > 20 first:
- These are the most error-prone
- Hardest to test thoroughly
- Most likely to contain hidden bugs

### Priority 2: Long Functions
Functions > 150 lines should be refactored immediately
- Break into smaller, testable units
- Each function should do ONE thing

### Priority 3: Large Files
Files > 800 lines need splitting
- Group by feature/domain
- Consider service layer pattern

### Priority 4: Deep Nesting
Nesting > 4 levels needs simplification
- Use early returns
- Extract nested logic to functions
- Consider state machines for complex flows

## Refactoring Techniques

### 1. Extract Method
```typescript
// Before: Long function
function processData(data) {
  // 100 lines of code...
}

// After: Extracted methods
function processData(data) {
  const validated = validateData(data);
  const transformed = transformData(validated);
  return saveData(transformed);
}
```

### 2. Early Returns (Guard Clauses)
```typescript
// Before: Deep nesting
function process(user) {
  if (user) {
    if (user.isActive) {
      if (user.hasPermission) {
        // do work
      }
    }
  }
}

// After: Early returns
function process(user) {
  if (!user) return;
  if (!user.isActive) return;
  if (!user.hasPermission) return;
  // do work
}
```

### 3. Strategy Pattern for Complex Conditionals
```typescript
// Before: High cyclomatic complexity
function calculate(type) {
  if (type === 'A') { /* logic */ }
  else if (type === 'B') { /* logic */ }
  else if (type === 'C') { /* logic */ }
  // ... 15 more conditions
}

// After: Strategy pattern
const strategies = {
  A: () => { /* logic */ },
  B: () => { /* logic */ },
  C: () => { /* logic */ },
};

function calculate(type) {
  return strategies[type]?.() ?? defaultStrategy();
}
```

### 4. Object Parameters
```typescript
// Before: Too many parameters
function createUser(name, email, age, address, phone, country) {
  // ...
}

// After: Object parameter
function createUser({ name, email, age, address, phone, country }) {
  // ...
}
```

## Running Complexity Analysis

```bash
# Run full lint to see all issues
npm run lint

# Run lint with auto-fix (won't fix complexity, but will fix syntax)
npm run lint:fix

# Generate complexity report
npm run lint:complexity
```

## Current Hotspots (Auto-detected by ESLint)

Files needing immediate attention:
1. `src/api/routers/playlists/index.ts` - Complexity: 104 ⚠️
2. `src/api/routers/ytdlp/index.ts` - Complexity: 58, File: 973 lines ⚠️
3. `src/api/routers/utils/index.ts` - Complexity: 31, File: 922 lines ⚠️
4. `src/api/utils/ytdlp-utils/metadata.ts` - Complexity: 47 ⚠️

