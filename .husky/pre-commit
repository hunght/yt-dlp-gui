#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Get the repository root
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

echo "üîç Running pre-commit checks..."

# Get all staged files (for test detection)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM || true)
STAGED_TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx)$' || true)

# Run type-check on all workspaces
echo "  ‚Üí Type checking..."
npm run type-check

# Run linting (only on staged TS/TSX files to keep it fast)
if [ -n "$STAGED_TS_FILES" ]; then
  # Lint files in electron app
  ELECTRON_TS_FILES=$(echo "$STAGED_TS_FILES" | grep "^apps/electron/" || true)
  if [ -n "$ELECTRON_TS_FILES" ]; then
    echo "  ‚Üí Linting electron TypeScript files..."
    cd "$REPO_ROOT/apps/electron"
    echo "$ELECTRON_TS_FILES" | sed 's|^apps/electron/||' | tr '\n' '\0' | xargs -0 npx eslint --fix --max-warnings=0
    cd "$REPO_ROOT"
  fi

  # Lint files in database package
  DATABASE_TS_FILES=$(echo "$STAGED_TS_FILES" | grep "^packages/database/" || true)
  if [ -n "$DATABASE_TS_FILES" ]; then
    echo "  ‚Üí Linting database TypeScript files..."
    cd "$REPO_ROOT/packages/database"
    echo "$DATABASE_TS_FILES" | sed 's|^packages/database/||' | tr '\n' '\0' | xargs -0 npx eslint --fix --max-warnings=0 2>/dev/null || true
    cd "$REPO_ROOT"
  fi

  echo "  ‚Üí Formatting staged files..."
  cd "$REPO_ROOT"
  for file in $STAGED_TS_FILES; do
    npx prettier --write "$file" 2>/dev/null || echo "    ‚ö†Ô∏è  Could not format $file"
  done
  # Re-add all formatted files at once
  echo "$STAGED_TS_FILES" | tr '\n' '\0' | xargs -0 git add 2>/dev/null || true
fi

# Run tests only for related files (skip test files themselves)
STAGED_SOURCE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx)$' | grep -v -E '\.(test|spec)\.(ts|tsx)$' || true)

if [ -n "$STAGED_SOURCE_FILES" ]; then
  echo "  ‚Üí Running tests for changed files..."

  # Convert file paths to absolute paths for Jest
  ABSOLUTE_STAGED_FILES=$(echo "$STAGED_SOURCE_FILES" | xargs -I {} echo "$REPO_ROOT/{}")

  # Run Jest with --findRelatedTests for the electron app
  if echo "$STAGED_SOURCE_FILES" | grep -q "^apps/electron/"; then
    ELECTRON_FILES=$(echo "$ABSOLUTE_STAGED_FILES" | grep "apps/electron/" || true)
    if [ -n "$ELECTRON_FILES" ]; then
      echo "    ‚Ä¢ Testing related files in electron app..."
      cd "$REPO_ROOT/apps/electron"
      echo "$ELECTRON_FILES" | xargs npx jest --bail --findRelatedTests --passWithNoTests || {
        echo "‚ùå Tests failed for electron app"
        exit 1
      }
      cd "$REPO_ROOT"
    fi
  fi

  # Run tests for database package if needed
  if echo "$STAGED_SOURCE_FILES" | grep -q "^packages/database/"; then
    DATABASE_FILES=$(echo "$ABSOLUTE_STAGED_FILES" | grep "packages/database/" || true)
    if [ -n "$DATABASE_FILES" ]; then
      echo "    ‚Ä¢ Testing related files in database package..."
      cd "$REPO_ROOT/packages/database"
      # Add test command when database has tests
      # echo "$DATABASE_FILES" | xargs npx jest --bail --findRelatedTests --passWithNoTests
      cd "$REPO_ROOT"
    fi
  fi
fi

echo "‚úÖ Pre-commit checks passed!"

